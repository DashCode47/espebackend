generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  DRIVER
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  career        String
  gender        String
  bio           String?
  avatarUrl     String?
  role          UserRole  @default(STUDENT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  interests     String[]
  isVisible     Boolean   @default(true)

  // Relaciones
  connectionsInitiated Connection[] @relation("ConnectionsInitiated")
  connectionsReceived  Connection[] @relation("ConnectionsReceived")
  messagesSent     Message[] @relation("MessagesSent")
  messagesReceived Message[] @relation("MessagesReceived")
  posts            Post[]
  reactions        PostReaction[]
  notifications    Notification[]
  reports          Report[]
  comments         Comment[]
  
  // New relations for user interactions
  interactionsInitiated UserInteraction[] @relation("InteractionsInitiated")
  interactionsReceived  UserInteraction[] @relation("InteractionsReceived")
  
  // Carpooling relations
  tripsAsDriver    Trip[] @relation("DriverTrips")
  tripRequests     TripRequest[]
  ratingsGiven      TripRating[] @relation("RatingsGiven")
  ratingsReceived   TripRating[] @relation("RatingsReceived")
  
  // Events relations
  eventsCreated    Event[]
  eventAttendances EventAttendance[]
}

model Connection {
  id        String   @id @default(uuid())
  user1Id   String
  user2Id   String
  createdAt DateTime @default(now())

  // Relations
  user1     User     @relation("ConnectionsInitiated", fields: [user1Id], references: [id])
  user2     User     @relation("ConnectionsReceived", fields: [user2Id], references: [id])

  messages  Message[]

  @@unique([user1Id, user2Id])
}

model Message {
  id        String   @id @default(cuid())
  sender    User     @relation("MessagesSent", fields: [senderId], references: [id])
  senderId  String
  receiver  User     @relation("MessagesReceived", fields: [receiverId], references: [id])
  receiverId String
  content   String
  createdAt DateTime @default(now())

  connection     Connection?   @relation(fields: [connectionId], references: [id])
  connectionId   String?
}

enum PostType {
  CONFESSION
  MARKETPLACE
  LOST_AND_FOUND
}

model Post {
  id        String   @id @default(uuid())
  author    User       @relation(fields: [authorId], references: [id])
  authorId  String
  content   String
  type      PostType
  title     String?
  imageUrl  String?
  createdAt DateTime   @default(now())

  reactions PostReaction[]
  reports   Report[]
  comments  Comment[]
}

model PostReaction {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  post      Post     @relation(fields: [postId], references: [id])
  postId    String
  isLike    Boolean
  createdAt DateTime @default(now())
}

model Report {
  id        String   @id @default(cuid())
  reporter  User     @relation(fields: [reporterId], references: [id])
  reporterId String
  post      Post     @relation(fields: [postId], references: [id])
  postId    String
  reason    String
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model UserInteraction {
  id        String   @id @default(uuid())
  user1Id   String   // User who initiated the interaction
  user2Id   String   // User who received the interaction
  type      String   // "LIKE" or "DISLIKE"
  createdAt DateTime @default(now())

  // Relations
  user1     User     @relation("InteractionsInitiated", fields: [user1Id], references: [id])
  user2     User     @relation("InteractionsReceived", fields: [user2Id], references: [id])

  @@unique([user1Id, user2Id])
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String
  post      Post     @relation(fields: [postId], references: [id])
  postId    String
}

model Banner {
  id          String   @id @default(uuid())
  title       String
  description String
  imageUrl    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Establishment {
  id          String       @id @default(uuid())
  name        String
  description String?
  address     String
  phone       String?
  email       String?
  imageUrl    String?
  website     String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  promotions  Promotion[]

  @@index([isActive])
}

enum PromotionCategory {
  FOOD
  DRINKS
  EVENTS
  PARTIES
  OTHER
}

model Promotion {
  id              String            @id @default(uuid())
  title           String
  description     String
  imageUrl        String?
  startDate       DateTime
  endDate         DateTime
  category        PromotionCategory
  discount        Int?              @default(0)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  establishmentId String
  establishment   Establishment    @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  @@index([establishmentId])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

model Career {
  id                    String   @id @default(uuid())
  code                  String   @unique
  name                  String
  modality              String   // Presencial, Semipresencial, Virtual
  duration              Int      // Duración en semestres
  schedule              String   // Matutina, Vespertina, Nocturna
  campus                String
  cesResolution         String   // Resolución del CES
  directorName          String
  directorEmail         String
  accreditations        String[] // Array de acreditaciones
  mission               String
  vision                String
  objectives            String[]
  graduateProfile       String   // Perfil de egreso general
  professionalProfile   String   // Perfil de egreso profesional
  curriculumPdfUrl      String?  // URL del PDF de la malla curricular
  curriculumDescription String   // Descripción de la malla curricular
  subjects              String[] // Lista de asignaturas
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

enum TripStatus {
  ACTIVE
  FULL
  CANCELLED
}

enum TripRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Trip {
  id            String          @id @default(uuid())
  driverId      String
  driver        User            @relation("DriverTrips", fields: [driverId], references: [id])
  origin        String
  destination   String
  departureTime DateTime
  availableSeats Int
  price         Float?
  notes         String?
  status        TripStatus      @default(ACTIVE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  requests      TripRequest[]
  ratings       TripRating[]
}

model TripRequest {
  id          String            @id @default(uuid())
  tripId      String
  trip        Trip              @relation(fields: [tripId], references: [id])
  passengerId String
  passenger   User              @relation(fields: [passengerId], references: [id])
  status      TripRequestStatus @default(PENDING)
  createdAt   DateTime          @default(now())

  @@unique([tripId, passengerId])
}

model TripRating {
  id          String   @id @default(uuid())
  tripId      String
  trip        Trip     @relation(fields: [tripId], references: [id])
  raterId     String
  rater       User     @relation("RatingsGiven", fields: [raterId], references: [id])
  driverId    String
  driver      User     @relation("RatingsReceived", fields: [driverId], references: [id])
  rating      Int      // 1-5
  comment     String?
  createdAt   DateTime @default(now())

  @@unique([tripId, raterId])
}

enum EventCategory {
  SOCIAL
  ACADEMIC
  PRIVATE
  SPORTS
  OTHER
}

model Event {
  id          String   @id @default(uuid())
  nombre      String
  descripcion String
  categoria   EventCategory
  fechaInicio DateTime
  fechaFin    DateTime?
  ubicacion   String
  precio      Float    @default(0)
  creadoPor   String
  creador     User     @relation(fields: [creadoPor], references: [id])
  imagen      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  attendances EventAttendance[]

  @@index([categoria])
  @@index([fechaInicio])
  @@index([ubicacion])
}

model EventAttendance {
  id        String   @id @default(uuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}
